<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Розроблення модуля | @molfar/amqp-client</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/amqp-client/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="description" content="Програмний модуль @molfar/amqp-client">
    
    <link rel="preload" href="/amqp-client/assets/css/0.styles.d42e7421.css" as="style"><link rel="preload" href="/amqp-client/assets/js/app.867c8b74.js" as="script"><link rel="preload" href="/amqp-client/assets/js/2.3c9290c8.js" as="script"><link rel="preload" href="/amqp-client/assets/js/18.2e71cec6.js" as="script"><link rel="prefetch" href="/amqp-client/assets/js/10.a1e50779.js"><link rel="prefetch" href="/amqp-client/assets/js/11.a6c80e49.js"><link rel="prefetch" href="/amqp-client/assets/js/12.d24dbe5d.js"><link rel="prefetch" href="/amqp-client/assets/js/13.4539a071.js"><link rel="prefetch" href="/amqp-client/assets/js/14.60286b71.js"><link rel="prefetch" href="/amqp-client/assets/js/15.edfaf9ac.js"><link rel="prefetch" href="/amqp-client/assets/js/16.6890931b.js"><link rel="prefetch" href="/amqp-client/assets/js/17.98b433cf.js"><link rel="prefetch" href="/amqp-client/assets/js/19.718caf4a.js"><link rel="prefetch" href="/amqp-client/assets/js/20.233dd389.js"><link rel="prefetch" href="/amqp-client/assets/js/21.64f0523e.js"><link rel="prefetch" href="/amqp-client/assets/js/3.af796a2a.js"><link rel="prefetch" href="/amqp-client/assets/js/4.20d4c44f.js"><link rel="prefetch" href="/amqp-client/assets/js/5.2e9be1db.js"><link rel="prefetch" href="/amqp-client/assets/js/6.4ac4a6fa.js"><link rel="prefetch" href="/amqp-client/assets/js/7.3e45abe9.js"><link rel="prefetch" href="/amqp-client/assets/js/8.5da71c72.js"><link rel="prefetch" href="/amqp-client/assets/js/9.e19bea28.js">
    <link rel="stylesheet" href="/amqp-client/assets/css/0.styles.d42e7421.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/amqp-client/" class="home-link router-link-active"><!----> <span class="site-name">@molfar/amqp-client</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/amqp-client/" class="nav-link">
  Початок
</a></div> <a href="https://github.com/wdc-molfar/amqp-client" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/amqp-client/" class="nav-link">
  Початок
</a></div> <a href="https://github.com/wdc-molfar/amqp-client" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/amqp-client/intro/" class="sidebar-link">Вступ</a></li><li><a href="/amqp-client/requirements/" class="sidebar-link">Вимоги</a></li><li><a href="/amqp-client/oas/" aria-current="page" class="active sidebar-link">Розроблення модуля</a></li><li><a href="/amqp-client/api/" class="sidebar-link">Специфікація модуля</a></li><li><a href="/amqp-client/test/" class="sidebar-link">Програма випобувань</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="розроблення-модуля"><a href="#розроблення-модуля" class="header-anchor">#</a> Розроблення модуля</h1> <h2 id="приклади-використання"><a href="#приклади-використання" class="header-anchor">#</a> Приклади використання</h2> <h3 id="завантаження-залежності"><a href="#завантаження-залежності" class="header-anchor">#</a> Завантаження залежності</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>  <span class="token function">npm</span> <span class="token function">install</span> --save wdc-molfar
</code></pre></div><h3 id="базовии-приклад"><a href="#базовии-приклад" class="header-anchor">#</a> Базовий приклад</h3> <p>Створюємо інстанси <code>publisher</code> і <code>consumer</code> за допомогою базових і кастомних параметрів для підключення та відправляємо 5 тестових повідомлень, які отримуємо через логування в <code>consumer</code> у <code>Buffer</code> форматі.</p> <center><img src="https://www.plantuml.com/plantuml/svg/PL1B2W8n3DrxYZ2klS5G1iIzdc08dJ0kx6Vw0OzlqpOL4KfuBybxIRh4X25bype1b0TmPCe4C2MAQO9vVZ1N2Z12XJzDQ0w_SkTAR_r4knDBRXqtbJ0u8n8XjZ4rQ6UyisHJiTBEncmeiC6rusOWx5_ZWzkoRffxnqqZJ8RATID_KMEnMXXRbiBtpeeu9Jkmpq9sAn_s0G00" alt="uml diagram"></center> <p>Створення екземплярів <code>publisher</code> і <code>consumer</code> здійснюється за допомогою  <code>AmqpManager.createConsumer()</code> та <code>AmqpManager.createPublisher()</code>. Надсилання повідомлень здійснюється за допомогою <code>publisher.send()</code>. Налаштування обробленя повідомлень
споживачем здійснюється за допомогою <code>consumer.use()</code>, а ініціалізація прослуховування черги - за допомогою <code>consumer.start()</code>.</p> <p>Крім того, можна використовувати ланцюжок викліків типу <code>consumer.use().use().start()</code></p> <p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Consumer<span class="token punctuation">,</span> Publisher <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'amqps://xoilebqg:Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> exchange <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'amqp_test_exchange'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> consumerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    exchange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publisherOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  exchange<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> consumer
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Consume: '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> publisher <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  publisher<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    msg<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">test message </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Consume:  <span class="token operator">&lt;</span>Buffer 7b <span class="token number">22</span> <span class="token number">64</span> <span class="token number">61</span> <span class="token number">74</span> <span class="token number">61</span> <span class="token number">22</span> 3a <span class="token number">22</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">73</span> <span class="token number">74</span> <span class="token number">20</span> 6d <span class="token number">65</span> <span class="token number">73</span> <span class="token number">73</span> <span class="token number">61</span> <span class="token number">67</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">31</span> <span class="token number">22</span> 7d<span class="token operator">&gt;</span>
Consume:  <span class="token operator">&lt;</span>Buffer 7b <span class="token number">22</span> <span class="token number">64</span> <span class="token number">61</span> <span class="token number">74</span> <span class="token number">61</span> <span class="token number">22</span> 3a <span class="token number">22</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">73</span> <span class="token number">74</span> <span class="token number">20</span> 6d <span class="token number">65</span> <span class="token number">73</span> <span class="token number">73</span> <span class="token number">61</span> <span class="token number">67</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">32</span> <span class="token number">22</span> 7d<span class="token operator">&gt;</span>
Consume:  <span class="token operator">&lt;</span>Buffer 7b <span class="token number">22</span> <span class="token number">64</span> <span class="token number">61</span> <span class="token number">74</span> <span class="token number">61</span> <span class="token number">22</span> 3a <span class="token number">22</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">73</span> <span class="token number">74</span> <span class="token number">20</span> 6d <span class="token number">65</span> <span class="token number">73</span> <span class="token number">73</span> <span class="token number">61</span> <span class="token number">67</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">33</span> <span class="token number">22</span> 7d<span class="token operator">&gt;</span>
Consume:  <span class="token operator">&lt;</span>Buffer 7b <span class="token number">22</span> <span class="token number">64</span> <span class="token number">61</span> <span class="token number">74</span> <span class="token number">61</span> <span class="token number">22</span> 3a <span class="token number">22</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">73</span> <span class="token number">74</span> <span class="token number">20</span> 6d <span class="token number">65</span> <span class="token number">73</span> <span class="token number">73</span> <span class="token number">61</span> <span class="token number">67</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">34</span> <span class="token number">22</span> 7d<span class="token operator">&gt;</span>
Consume:  <span class="token operator">&lt;</span>Buffer 7b <span class="token number">22</span> <span class="token number">64</span> <span class="token number">61</span> <span class="token number">74</span> <span class="token number">61</span> <span class="token number">22</span> 3a <span class="token number">22</span> <span class="token number">74</span> <span class="token number">65</span> <span class="token number">73</span> <span class="token number">74</span> <span class="token number">20</span> 6d <span class="token number">65</span> <span class="token number">73</span> <span class="token number">73</span> <span class="token number">61</span> <span class="token number">67</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">35</span> <span class="token number">22</span> 7d<span class="token operator">&gt;</span>
Consume:  <span class="token operator">&lt;</span>Buffer <span class="token number">22</span> <span class="token number">68</span> <span class="token number">65</span> 6c 6c 6f <span class="token number">2</span><span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
Consume:  <span class="token operator">&lt;</span>Buffer 7b <span class="token number">22</span> <span class="token number">64</span> <span class="token number">61</span> <span class="token number">74</span> <span class="token number">61</span> <span class="token number">22</span> 3a <span class="token number">31</span> <span class="token number">30</span> 7d<span class="token operator">&gt;</span>  

</code></pre></div><h3 id="ланцюжки-оброблення-повідомлень"><a href="#ланцюжки-оброблення-повідомлень" class="header-anchor">#</a> Ланцюжки оброблення повідомлень</h3> <p>Насамперед, функція типу middleware(): (err, msg, next) =&gt; {}</p> <p>Бібліотека підтримує використання ланцюжків оброблення повідомлень <code>middlewares</code>.</p> <center><img src="https://www.plantuml.com/plantuml/svg/XT6n2W8n383X_PuYey8vNBivoBrAR8C4stha8lhuLt2evAH2b_2HFqFdLL7qcTC0K1_0KaSEl61HuCBAg0_vqCupnvZeXK9Jnrp7V0ktOwVBhlmr6pv3m9Ik6ExJWKH6oEjjX49lFVOtdM5dk8NTdx3Pz8QzuHRsFyB3J2NM_zW0" alt="uml diagram"></center> <p>Додавання обробника до ланцюжка оброблення повідомлень здійснюється за допомогою <code>consumer.use()</code>(<code>publisher.use()</code>).
<code>consumer.use()</code>(<code>publisher.use()</code>) підтримує як додавання окремих обробників, так і масивів обробників. Обробники виконуються в порядку додавання до ланцюжка за допомогою  <code>consumer.use()</code>(<code>publisher.use()</code>).</p> <p>Окрім попереднього пункту про ініціалізацію publisher-consumer інстансів додається ланцюжок з колбеків, які виконуються послідовно і пропускають через себе 3 параметри: помилка, дані, колбек виклику наступної функції по черзі.</p> <p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Consumer<span class="token punctuation">,</span> Publisher <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'amqps://xoilebqg:Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> exchange <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'amqp_test_exchange'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> consumerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    exchange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publisherOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  exchange<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> consumer
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Consume: '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Process:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> publisher <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  publisher<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    msg<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">test message </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Consume:  hello
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Process: hello
Consume:  <span class="token punctuation">{</span> data: <span class="token number">10</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token number">10</span> <span class="token punctuation">}</span>

</code></pre></div><h3 id="стандартні-обробники-повідомлень"><a href="#стандартні-обробники-повідомлень" class="header-anchor">#</a> Стандартні обробники повідомлень</h3> <p>Бібліотека надає стандартні обробники повідомлень та генератори обробників:
Middlewares - це об'єкт, який містить в собі наступні обробники:</p> <ul><li>Schema - функція-фабрика, яка інкапсулює в собі schema, яку обернено за допомогою ajv(валідаційна бібліотека) та повертає функцію типу middleware, що містить логіку для валідації</li> <li>Json - об'єкт з двох методів типу middleware stringify та parse, що містять логіку однойменних методів глобального об'єкту JSON в JavaScriptі.
Доступ до стандартних обробників здійснюється за допомогою</li> <li>Filter - функція-фабрика, яка повертає функцію функцію типу middleware, що містить в собі виклик функції predicate, контракт якої має задовольняти повернення булевого значення</li> <li>Error - об'єкт з двох методів типу middleware BreakChain(якщо помилка, далі ланцюжок акшинів виконуваться не буде) і Log(вивід в консоль помилки, якщо вона є)</li> <li>Metric - функція-фабрика, яка приймає options, для ініціалізації метрики з prom-client певного типу і логіки, та повертає функцію типу middleware, яка і викликає callback для старту метрик.</li></ul> <p><code>Middleware.middleware or middleware group or middleware generator[.middleware or middleware generator call[(call params)]]</code></p> <p>Апгрейд попереднього прикладу, додана здатність фільрувати повідомлення по критеріям: послідовний ланцюжок з <code>middleware</code> дає змогу через
<code>Consume Log</code> вивести всі отримані повідомлення в consumerі але до <code>Process Log</code> доходить лише повідомлення, яке відповідає критерію фільтрування, що закінчується на 5</p> <p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Consumer<span class="token punctuation">,</span> Publisher<span class="token punctuation">,</span> Middlewares <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'amqps://xoilebqg:Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> exchange <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'amqp_test_exchange'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> consumerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    exchange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publisherOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  exchange<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> consumer
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Consume: '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> msg<span class="token punctuation">.</span>content <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Process:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> publisher <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  publisher
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Send:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">test message </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Send: hello
Send: <span class="token punctuation">{</span> data: <span class="token number">10</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Consume:  hello
Process: hello
Consume:  <span class="token punctuation">{</span> data: <span class="token number">10</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token number">10</span> <span class="token punctuation">}</span>     

</code></pre></div><h2 id="валідація-повідомлень"><a href="#валідація-повідомлень" class="header-anchor">#</a> Валідація повідомлень</h2> <p>Як уже було згадано, Middlewares.Schema.validator приймає schema, яка налаштовує ajv.compile метод, який інкапсулює ValidationFunction для валідації даних. Ці дані &quot;приходять&quot; в msg, в middleware. Якщо процес валідації завершився неуспішно(validate.errors not null), то далі ланцюжок з інших middleware не виконається, адже повернеться помилка.</p> <h3 id="валідація-повідомлень-на-стороні-публікувальника"><a href="#валідація-повідомлень-на-стороні-публікувальника" class="header-anchor">#</a> Валідація повідомлень на стороні публікувальника:</h3> <p>Додано middleware, яке валідує повідомлення, яке надходить у <code>publisher</code>.</p> <p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Consumer<span class="token punctuation">,</span> Publisher<span class="token punctuation">,</span> Middlewares <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'amqps://xoilebqg:Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> exchange <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'amqp_test_exchange'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> consumerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    exchange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publisherOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  exchange<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
  required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  properties<span class="token operator">:</span> <span class="token punctuation">{</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  errorMessage<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'The sended message should be a object'</span><span class="token punctuation">,</span>
    properties<span class="token operator">:</span> <span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token string">'The sended message data should be a string'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> consumer
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Consume: '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> msg<span class="token punctuation">.</span>content <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Process:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> publisher <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  publisher
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Send:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">test message </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Error: Bad message format.
<span class="token string">&quot;hello&quot;</span>
On the path <span class="token string">&quot;#&quot;</span><span class="token builtin class-name">:</span> The sended message should be a object
    at Array.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>schema.js:12:13<span class="token punctuation">)</span>
    at Middleware.execute <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>wrapper.js:35:54<span class="token punctuation">)</span>
    at Publisher.send <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>infrastructure<span class="token punctuation">\</span>publisher.js:63:30<span class="token punctuation">)</span>
    at run <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>examples<span class="token punctuation">\</span>use-validation<span class="token punctuation">\</span>publisher<span class="token punctuation">\</span>index.js:80:19<span class="token punctuation">)</span>
    at processTicksAndRejections <span class="token punctuation">(</span>internal/process/task_queues.js:95:5<span class="token punctuation">)</span>
Error: Bad message format.
<span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span>:10<span class="token punctuation">}</span>
On the path <span class="token string">&quot;/data&quot;</span><span class="token builtin class-name">:</span> The sended message data should be a string
    at Array.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>schema.js:12:13<span class="token punctuation">)</span>
    at Middleware.execute <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>wrapper.js:35:54<span class="token punctuation">)</span>
    at Publisher.send <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>infrastructure<span class="token punctuation">\</span>publisher.js:63:30<span class="token punctuation">)</span>
    at run <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>examples<span class="token punctuation">\</span>use-validation<span class="token punctuation">\</span>publisher<span class="token punctuation">\</span>index.js:81:19<span class="token punctuation">)</span>
    at processTicksAndRejections <span class="token punctuation">(</span>internal/process/task_queues.js:95:5<span class="token punctuation">)</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>

</code></pre></div><h3 id="валідація-повідомлень-на-стороні-споживача"><a href="#валідація-повідомлень-на-стороні-споживача" class="header-anchor">#</a> Валідація повідомлень на стороні споживача:</h3> <p>Додано middleware, яке валідує повідомлення, яке надходить з <code>consumer</code></p> <p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Consumer<span class="token punctuation">,</span> Publisher<span class="token punctuation">,</span> Middleware<span class="token punctuation">,</span> yaml2js <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../../lib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'amqps://xoilebqg:Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> exchange <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'amqp_test_exchange'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> consumerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    exchange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publisherOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  exchange<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> inputSchema <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  type: object
  required:
      - data
  properties:
      data:
          type: string
  errorMessage:
      type: The consumed message should be a object           
      properties:
          data: The consumed message data should be a string

</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> consumer
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Consume: '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>inputSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> msg<span class="token punctuation">.</span>content <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Process:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> publisher <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  publisher
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Send:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">test message </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Send: hello
Send: <span class="token punctuation">{</span> data: <span class="token number">10</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Consume:  hello
Error: Bad message format.
<span class="token string">&quot;hello&quot;</span>
On the path <span class="token string">&quot;#&quot;</span><span class="token builtin class-name">:</span> The consumed message should be a object
    at Array.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>schema.js:12:13<span class="token punctuation">)</span>
    at Middleware.execute <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>wrapper.js:35:54<span class="token punctuation">)</span>
    at processTicksAndRejections <span class="token punctuation">(</span>internal/process/task_queues.js:95:5<span class="token punctuation">)</span>
    at async G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>infrastructure<span class="token punctuation">\</span>consumer.js:78:13
Consume:  <span class="token punctuation">{</span> data: <span class="token number">10</span> <span class="token punctuation">}</span>
Error: Bad message format.
<span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span>:10<span class="token punctuation">}</span>
On the path <span class="token string">&quot;/data&quot;</span><span class="token builtin class-name">:</span> The consumed message data should be a string
    at Array.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>schema.js:12:13<span class="token punctuation">)</span>
    at Middleware.execute <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>wrapper.js:35:54<span class="token punctuation">)</span>
    at processTicksAndRejections <span class="token punctuation">(</span>internal/process/task_queues.js:95:5<span class="token punctuation">)</span>
    at async G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>infrastructure<span class="token punctuation">\</span>consumer.js:78:13  

</code></pre></div><h2 id="використання-метрик"><a href="#використання-метрик" class="header-anchor">#</a> Використання метрик</h2> <p>Prometheus це модель даних для опису та запису показників(metrics) у часі.
prom-client - rлієнт prometheus для Node.js, який підтримує гістограми, підсумки, вимірювальні прилади та лічильники.
Метрика — це об’єкт даних, який дозволяє записувати дані про продуктивність своєї системи. Модель даних Prometheus дозволяє записувати: oas</p> <ul><li>Що щось сталося</li> <li>Скільки разів це було</li> <li>Коли це сталося</li> <li>Скільки часу знадобилося, щоб щось закінчилося</li></ul> <p>Middlewares.Metric приймає об'єкт з 2 полями:</p> <ul><li>metric - містить інстанс певного типу метрики з prom-client з відповідними полями для Налаштування</li> <li>callback - функція типу middleware, яка дозволяє робити акшини відповідно до функціоналу створеної метрики(наприклад для Counter це збільшення лічильника)</li></ul> <p>Додано middleware, яке на на меті реєстрацію метрик для збору статистики.</p> <p><em><strong>Приклади використання двох видів метрик, взятих з репозиторію prom-client</strong></em></p> <h4 id="counter"><a href="#counter" class="header-anchor">#</a> Counter</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Counter<span class="token punctuation">,</span> register <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prom-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		name<span class="token operator">:</span> <span class="token string">'test_counter'</span><span class="token punctuation">,</span>
		help<span class="token operator">:</span> <span class="token string">'Example of a counter'</span><span class="token punctuation">,</span>
		labelNames<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	c<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	# HELP test_counter Example of a counter
	# TYPE test_counter counter
	test_counter{code=&quot;200&quot;} 1
	*/</span>

	c<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	# HELP test_counter Example of a counter
	# TYPE test_counter counter
	test_counter{code=&quot;200&quot;} 2
	*/</span>

	c<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	# HELP test_counter Example of a counter
	# TYPE test_counter counter
	test_counter{code=&quot;200&quot;} 2
	test_counter 1
	*/</span>

	c<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	# HELP test_counter Example of a counter
	# TYPE test_counter counter
	*/</span>

	c<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	# HELP test_counter Example of a counter
	# TYPE test_counter counter
	test_counter 15
	*/</span>

	c<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	# HELP test_counter Example of a counter
	# TYPE test_counter counter
	test_counter 15
	test_counter{code=&quot;200&quot;} 12
	*/</span>

	c<span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">'200'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	# HELP test_counter Example of a counter
	# TYPE test_counter counter
	test_counter 15
	test_counter{code=&quot;200&quot;} 24
	*/</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="histogram"><a href="#histogram" class="header-anchor">#</a> Histogram</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> register<span class="token punctuation">,</span> Histogram <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prom-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Histogram</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	name<span class="token operator">:</span> <span class="token string">'test_histogram'</span><span class="token punctuation">,</span>
	help<span class="token operator">:</span> <span class="token string">'Example of a histogram'</span><span class="token punctuation">,</span>
	labelNames<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

h<span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">'200'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
h<span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">'300'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
h<span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">'300'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
h<span class="token punctuation">.</span><span class="token function">labels</span><span class="token punctuation">(</span><span class="token string">'200'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

register<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">str</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
Output from metrics():
# HELP test_histogram Example of a histogram
# TYPE test_histogram histogram
test_histogram_sum{code=&quot;200&quot;,color=&quot;blue&quot;} 0.4
test_histogram_count{code=&quot;200&quot;,color=&quot;blue&quot;} 1
test_histogram_sum{code=&quot;300&quot;,color=&quot;red&quot;} 0.6
test_histogram_count{code=&quot;300&quot;,color=&quot;red&quot;} 1
test_histogram_sum{code=&quot;300&quot;,color=&quot;blue&quot;} 0.4
test_histogram_count{code=&quot;300&quot;,color=&quot;blue&quot;} 1
test_histogram_sum{code=&quot;200&quot;,color=&quot;red&quot;} 0.6
test_histogram_count{code=&quot;200&quot;,color=&quot;red&quot;} 1
*/</span>
</code></pre></div><p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js<span class="token punctuation">,</span> getMetrics <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Counter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prom-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'amqps://xoilebqg:Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg?heartbeat=60'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> exchange <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'amqp_test_exchange'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> consumerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  queue<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
    exchange<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publisherOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  amqp<span class="token punctuation">,</span>
  exchange<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
  required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  properties<span class="token operator">:</span> <span class="token punctuation">{</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  errorMessage<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'The sended message should be a object'</span><span class="token punctuation">,</span>
    properties<span class="token operator">:</span> <span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token string">'The sended message data should be a string'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> inputSchema <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  type: object
  required:
    - data
  properties:
    data:
      type: string
  errorMessage:
    type: The consumed message should be a object
    properties:
      data: The consumed message data should be a string
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pStages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'p_stages'</span><span class="token punctuation">,</span>
    help<span class="token operator">:</span> <span class="token string">'Stages of producer process'</span><span class="token punctuation">,</span>
    labelNames<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'stage'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> cStages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'c_stages'</span><span class="token punctuation">,</span>
    help<span class="token operator">:</span> <span class="token string">'Stages of consumer process'</span><span class="token punctuation">,</span>
    labelNames<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'stage'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> consumer
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'consumed_messages'</span><span class="token punctuation">,</span>
          help<span class="token operator">:</span> <span class="token string">'Counter of Consumed messages'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> cStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'consumed'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Consume: '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>inputSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> cStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'validation-errors'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> cStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'validated'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> msg<span class="token punctuation">.</span>content <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> cStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'processed'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Process:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> publisher <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  publisher
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> pStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'generated'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> pStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'validation-errors'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> pStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'validated'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'produced_messages'</span><span class="token punctuation">,</span>
          help<span class="token operator">:</span> <span class="token string">'Counter of Produced messages'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Send:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
      Middlewares<span class="token punctuation">.</span><span class="token function">Metric</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        metric<span class="token operator">:</span> pStages<span class="token punctuation">,</span>
        <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> metric</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          metric<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stage<span class="token operator">:</span> <span class="token string">'sended'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">test message </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> publisher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> metrics <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Metrics:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>metrics<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Send: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Error: Bad message format.
<span class="token string">&quot;hello&quot;</span>
On the path <span class="token string">&quot;#&quot;</span><span class="token builtin class-name">:</span> The sended message should be a object
    at Array.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>schema.js:12:13<span class="token punctuation">)</span>
    at Middleware.execute <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>wrapper.js:35:54<span class="token punctuation">)</span>
    at processTicksAndRejections <span class="token punctuation">(</span>internal/process/task_queues.js:95:5<span class="token punctuation">)</span>
    at async Publisher.send <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>infrastructure<span class="token punctuation">\</span>publisher.js:63:7<span class="token punctuation">)</span>
    at async run <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>examples<span class="token punctuation">\</span>use-metrics<span class="token punctuation">\</span>index.js:182:3<span class="token punctuation">)</span>
Error: Bad message format.
<span class="token punctuation">{</span><span class="token string">&quot;data&quot;</span>:10<span class="token punctuation">}</span>
On the path <span class="token string">&quot;/data&quot;</span><span class="token builtin class-name">:</span> The sended message data should be a string
    at Array.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>schema.js:12:13<span class="token punctuation">)</span>
    at Middleware.execute <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>middlewares<span class="token punctuation">\</span>wrapper.js:35:54<span class="token punctuation">)</span>
    at processTicksAndRejections <span class="token punctuation">(</span>internal/process/task_queues.js:95:5<span class="token punctuation">)</span>
    at async Publisher.send <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>lib<span class="token punctuation">\</span>infrastructure<span class="token punctuation">\</span>publisher.js:63:7<span class="token punctuation">)</span>
    at async run <span class="token punctuation">(</span>G:<span class="token punctuation">\</span>bachelor<span class="token punctuation">\</span>amqp-client<span class="token punctuation">\</span>examples<span class="token punctuation">\</span>use-metrics<span class="token punctuation">\</span>index.js:183:3<span class="token punctuation">)</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 1'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 2'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 3'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 4'</span> <span class="token punctuation">}</span>
Consume:  <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Process: <span class="token punctuation">{</span> data: <span class="token string">'test message 5'</span> <span class="token punctuation">}</span>
Metrics:
<span class="token punctuation">[</span>
 <span class="token punctuation">{</span>
  <span class="token string">&quot;help&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Stages of producer process&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;p_stages&quot;</span>,
  <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;counter&quot;</span>,
  <span class="token string">&quot;values&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">7</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;generated&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;validated&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sended&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;validation-errors&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;aggregator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sum&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>
  <span class="token string">&quot;help&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Stages of consumer process&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;c_stages&quot;</span>,
  <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;counter&quot;</span>,
  <span class="token string">&quot;values&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;consumed&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;validated&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;stage&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;processed&quot;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;aggregator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sum&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>
  <span class="token string">&quot;help&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Counter of Consumed messages&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;consumed_messages&quot;</span>,
  <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;counter&quot;</span>,
  <span class="token string">&quot;values&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;aggregator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sum&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token punctuation">{</span>
  <span class="token string">&quot;help&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Counter of Produced messages&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;produced_messages&quot;</span>,
  <span class="token string">&quot;type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;counter&quot;</span>,
  <span class="token string">&quot;values&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
   <span class="token punctuation">{</span>
    <span class="token string">&quot;value&quot;</span><span class="token builtin class-name">:</span> <span class="token number">5</span>,
    <span class="token string">&quot;labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;aggregator&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;sum&quot;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">]</span>    

</code></pre></div><h2 id="прослуховування-декількома-споживачами-однієі-черги-повідомлень"><a href="#прослуховування-декількома-споживачами-однієі-черги-повідомлень" class="header-anchor">#</a> Прослуховування декількома споживачами однієї черги повідомлень</h2> <p>У випадку, коли одні й ті ж свмі повідомлення повинні бути оброблені за допомогою різних алгоритмів, можна організувати
прослуховування однієї черги повідомлень декількома споживачами. В цьому випадку оброблення повідомлень цими споживачами буде здійснюватися паралельно.</p> <center><img src="https://www.plantuml.com/plantuml/svg/VL4z3y8W4Dtz5HSTEZcKkJOcnir1TvUpFJ-ISjG2YJzVQ87QHYKaSE_kFUuTMssmCrOs2m2t_QgKR1KJ6u1bswdQLjGjeIYEuLwMW1fY12j48iH03iVJaYN7PvIqoIwTmhf2RR8pIrKxv8gihCcyxFvLtP5lDCYcqgWxLsmUsX13xgadZmsy9lzU9-PrOjhefzc1uYpruZl5sifezn1o-L-Y-4qKC7ruUgHfhijn124tZcJjiide38w-choFKxyH5XFOLo-snBNx-JS0" alt="uml diagram"></center> <p>Для цього необхідно скористатись прикладами yaml конфігів, які наведені нижче. З головних деталей:</p> <ul><li>amqp.url однакова у всім consumer(те, що publisher i consumer мають однакову url без додаткових параметрів як роути, і так зрозуміло)</li> <li>queue.exchange.name однаоквий для двох consumer</li> <li>queue.exchange.mode === fanout для відправки повідомлення з обмінника в усі черги
З додаткового:</li> <li>message.id, message.listener, message.timeout</li></ul> <p>Ініціалізація 1 publisher і 2 consumer, які слухають одну й ту саму чергу, і через параметр listenerId повідомлення розподіляються між ними</p> <p><em><strong>Файл <code>listener1.yaml</code>. Налаштування першого прослуховувача</strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">queue</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> listen1
    <span class="token key atrule">exchange</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> broadcast
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout
        <span class="token key atrule">options</span><span class="token punctuation">:</span>
            <span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> 
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">noAck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        
<span class="token key atrule">message</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> object
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> id
        <span class="token punctuation">-</span> listener
        <span class="token punctuation">-</span> timeout
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">listener</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number  


</code></pre></div><p><em><strong>Файл <code>listener2.yaml</code>. Налаштування другого прослуховувача</strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token comment"># Worker AMQP settings</span>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">queue</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> listen2
    <span class="token key atrule">exchange</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> broadcast
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout
        <span class="token key atrule">options</span><span class="token punctuation">:</span>
            <span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">noAck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        
<span class="token key atrule">message</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> object
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> id
        <span class="token punctuation">-</span> listener
        <span class="token punctuation">-</span> timeout
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">listener</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number  


</code></pre></div><p><em><strong>Файл <code>producer.yaml</code>. Налаштування публікувальника</strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token comment"># Scheduler AMQP settings</span>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">exchange</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> broadcast
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">durable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        
<span class="token key atrule">message</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> object
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> id
        <span class="token punctuation">-</span> listener
        <span class="token punctuation">-</span> timeout
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">listener</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number  
          

</code></pre></div><p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js<span class="token punctuation">,</span> getMetrics <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> listener1Options <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./listener1.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> listener2Options <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./listener2.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> producerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./producer.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> producerPipe <span class="token operator">=</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>producerOptions<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Produce'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">listenerPipe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">listenerId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>listener1Options<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> msg<span class="token punctuation">.</span>content <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>listener <span class="token operator">===</span> listenerId<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Listener </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>listenerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> starts </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Listener </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>listenerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> complete </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> producer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>producerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>producerPipe<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> listener1 <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>listener1Options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> listener1<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">listenerPipe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> listener2 <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>listener2Options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> listener2<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">listenerPipe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> listener <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    listener<span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listener <span class="token operator">=</span> listener <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> i<span class="token punctuation">,</span>
      listener<span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> listener1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> listener2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Produce <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:0,<span class="token string">&quot;listener&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:4061<span class="token punctuation">}</span>
Produce <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;listener&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:373<span class="token punctuation">}</span>
Produce <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:2,<span class="token string">&quot;listener&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:863<span class="token punctuation">}</span>
Produce <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:3,<span class="token string">&quot;listener&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:955<span class="token punctuation">}</span>
Produce <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:4,<span class="token string">&quot;listener&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:886<span class="token punctuation">}</span>
Produce <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:5,<span class="token string">&quot;listener&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:876<span class="token punctuation">}</span>
Listener <span class="token number">1</span> starts <span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">4061</span>
Listener <span class="token number">2</span> starts <span class="token number">1</span> <span class="token builtin class-name">:</span> <span class="token number">373</span>
Listener <span class="token number">2</span> starts <span class="token number">3</span> <span class="token builtin class-name">:</span> <span class="token number">955</span>
Listener <span class="token number">2</span> starts <span class="token number">5</span> <span class="token builtin class-name">:</span> <span class="token number">876</span>
Listener <span class="token number">1</span> starts <span class="token number">2</span> <span class="token builtin class-name">:</span> <span class="token number">863</span>
Listener <span class="token number">1</span> starts <span class="token number">4</span> <span class="token builtin class-name">:</span> <span class="token number">886</span>
Listener <span class="token number">2</span> complete <span class="token number">1</span> <span class="token builtin class-name">:</span> <span class="token number">373</span>
Listener <span class="token number">1</span> complete <span class="token number">2</span> <span class="token builtin class-name">:</span> <span class="token number">863</span>
Listener <span class="token number">2</span> complete <span class="token number">5</span> <span class="token builtin class-name">:</span> <span class="token number">876</span>
Listener <span class="token number">1</span> complete <span class="token number">4</span> <span class="token builtin class-name">:</span> <span class="token number">886</span>
Listener <span class="token number">2</span> complete <span class="token number">3</span> <span class="token builtin class-name">:</span> <span class="token number">955</span>
Listener <span class="token number">1</span> complete <span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">4061</span>

</code></pre></div><h2 id="організація-черги-завдань"><a href="#організація-черги-завдань" class="header-anchor">#</a> Організація черги завдань</h2> <p>При необхідності організації паралельного однотипного оброблення повідомлень декількома обробниками, можна організувати
розбір завдань декількома споживачами з спільної черги завдань. На відміну від попереднього випадку, якщо вибірка повідомлення підтверджена одним з споживачів, інші споживачі вже не отримують це повідомлення.</p> <center><img src="https://www.plantuml.com/plantuml/svg/TP4nRy8m48Nt_8eJ39aOd9b4L5Kt1jYHggjzD2Zs6Uopoi_72Grk9V1mqldyFhzdRw9WaEHiLK5UshkpPs81M4JTaqcMmWBMwrtm9caANGSOOUvWYKY4E6cdSacKA8iP7RLG2qNv58n3VM3d3RMrEGNIKe_CZwlkaR_fplmA7et6A3Fq2V0VxnpeIA9xQ44TcFsR7beueeqqmlUZxawsglZx6_37Xo5dKEFnTyynkJdVzXI5c89wAMfUYneervNoUB9LLw9Ean9ybMU_PgsQkeUHPvjDLMs8JVwy6m00" alt="uml diagram"></center> <p>Для цього необхідно скористатись прикладами yaml конфігів, які наведені нижче. З головних деталей, які додались в порівнянні з попереднім прикладом:</p> <ul><li>queue.options.prefetch - якщо в обміннику є повідомлення, то consumer(в даному випадку worker за 1 раз &quot;забере&quot; вказане число повідомлень)</li> <li>queue.options.noAck - consumer може автоматично &quot;давати знати&quot;, що повідомлення доставлено, а можна це зробити мануально, викликавши метод .ack(), але пр цьому вказавши noAck: false.</li></ul> <p>Ініціалізація одного publisher і 2 consumer, які слухають одну й ту саму чергу як і в попередньому прикладі. Але, різниця полягає в тому, що в yaml конфігу задано noAck: false. Це означає, що потрібно викликати .ack(). Якщо цього не зробити, слухач &quot;зупиниться&quot; на цьому повідомленні, як і реалізовано: за час 4 сек, другий воркер опрацює всі повідомлення в черзі, а перший воркер буде 'вісіти' на першому повідомленні</p> <p><em><strong>Файл <code>scheduler.yaml</code>. Налаштування планувальника завдань</strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token comment"># Scheduler AMQP settings</span>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">exchange</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test_task
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> direct
        
<span class="token key atrule">message</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> object
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> id
        <span class="token punctuation">-</span> timeout
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number  
          

</code></pre></div><p><em><strong>Файл <code>worker.yaml</code>. Налаштування працівника</strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token comment"># Worker AMQP settings</span>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">queue</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test_task
    <span class="token key atrule">exchange</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> test_task
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> direct
    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">noAck</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        
<span class="token key atrule">message</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> object
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> id
        <span class="token punctuation">-</span> timeout
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number  


</code></pre></div><p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js<span class="token punctuation">,</span> getMetrics <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> consumerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./worker.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> publisherOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./scheduler.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> schedullerPipe <span class="token operator">=</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">workerPipe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">workerId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> fetch task </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> process </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> : </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> scheduler <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>publisherOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> scheduler<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>schedullerPipe<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> worker1 <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> worker1<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">workerPipe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> worker2 <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>consumerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> worker2<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">workerPipe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  scheduler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scheduler<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> i<span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> scheduler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> worker1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> worker2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Worker <span class="token number">1</span> fetch task <span class="token number">0</span>, <span class="token number">4073</span>
Worker <span class="token number">2</span> fetch task <span class="token number">2</span>, <span class="token number">600</span>
Worker <span class="token number">2</span> process <span class="token number">2</span> <span class="token builtin class-name">:</span> <span class="token number">600</span>
Worker <span class="token number">2</span> fetch task <span class="token number">3</span>, <span class="token number">642</span>
Worker <span class="token number">2</span> process <span class="token number">3</span> <span class="token builtin class-name">:</span> <span class="token number">642</span>
Worker <span class="token number">2</span> fetch task <span class="token number">4</span>, <span class="token number">779</span>
Worker <span class="token number">2</span> process <span class="token number">4</span> <span class="token builtin class-name">:</span> <span class="token number">779</span>
Worker <span class="token number">2</span> fetch task <span class="token number">5</span>, <span class="token number">1153</span>
Worker <span class="token number">1</span> process <span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">4073</span>
Worker <span class="token number">2</span> process <span class="token number">5</span> <span class="token builtin class-name">:</span> <span class="token number">1153</span>

</code></pre></div><h2 id="об-єднання-потоків-повідомлень"><a href="#об-єднання-потоків-повідомлень" class="header-anchor">#</a> Об'єднання потоків повідомлень</h2> <p>У випадку необхідності злиття потоків повідомлень для оброблення в одному обробнику використовується спільний обмінник повідомлень для декількох публікувальників.</p> <center><img src="https://www.plantuml.com/plantuml/svg/VP6x3i8m34NtVeLLXauTsXcgIeYD0NOMavg7rDWb3udF9scfGYKWWvNavfxu9grrQ9pNVPP164hq84pi0FB1d_kxlP61AeVr-c2ayufCqm1Qc5SLh1294F_Owz_sUc4VoyEJf-1drBI1GWch03Jen1GdrjB5tGkoU5T4yEwfRiXNci1d8zWfj6u6Vu4kcP5nZF84w5Cddsb254TC9fxU2bklvoZxjmB9c4fwfh9iKdCBhVwYZILbYGUcnlfnFj-PPIrn5txl1G00" alt="uml diagram"></center> <p>Для цього необхідно скористатись прикладами yaml конфігів, які наведені нижче. З головних деталей:</p> <ul><li>amqp.url, exchange.name, exchange.mode є однаковим</li> <li>валідація повідомлень представлена: message.id, message.producer, message.timeout</li></ul> <p><em><strong>Файл <code>listener.yaml</code>. Налаштування прослуховувача</strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>

<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">queue</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> dataflow
    
    <span class="token key atrule">exchange</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> concentrator
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">noAck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        
<span class="token key atrule">message</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> object
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> id
        <span class="token punctuation">-</span> producer
        <span class="token punctuation">-</span> timeout
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">producer</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number  

</code></pre></div><p><em><strong>Файл <code>producer.yaml</code>. Налаштування публікувальника</strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>

<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">exchange</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> concentrator
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout
        
<span class="token key atrule">message</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> object
    <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> id
        <span class="token punctuation">-</span> producer
        <span class="token punctuation">-</span> timeout
    <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">producer</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number
        <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> number  
          
</code></pre></div><p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js<span class="token punctuation">,</span> getMetrics <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> listenerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./listener.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> producerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./producer.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">producerPipe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">producerId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>producerOptions<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Producer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>producerId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> send </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> listenerPipe <span class="token operator">=</span> <span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>listenerOptions<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Listener starts'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Listener complete'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> producer1 <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>producerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> producer1<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">producerPipe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> producer2 <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>producerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> producer2<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">producerPipe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> listener <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>listenerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> listener<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>listenerPipe<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  producer1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    producer<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  producer2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    producer<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    producer1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> i<span class="token punctuation">,</span>
      producer<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    producer2<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> i<span class="token punctuation">,</span>
      producer<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> producer1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> producer2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> listener<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Producer <span class="token number">1</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:0,<span class="token string">&quot;producer&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:4534<span class="token punctuation">}</span>
Producer <span class="token number">2</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:0,<span class="token string">&quot;producer&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:4903<span class="token punctuation">}</span>
Producer <span class="token number">1</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;producer&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:515<span class="token punctuation">}</span>
Producer <span class="token number">2</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;producer&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:1077<span class="token punctuation">}</span>
Producer <span class="token number">1</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:2,<span class="token string">&quot;producer&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:1027<span class="token punctuation">}</span>
Producer <span class="token number">2</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:2,<span class="token string">&quot;producer&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:800<span class="token punctuation">}</span>
Producer <span class="token number">1</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:3,<span class="token string">&quot;producer&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:430<span class="token punctuation">}</span>
Producer <span class="token number">2</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:3,<span class="token string">&quot;producer&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:1175<span class="token punctuation">}</span>
Producer <span class="token number">1</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:4,<span class="token string">&quot;producer&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:537<span class="token punctuation">}</span>
Producer <span class="token number">2</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:4,<span class="token string">&quot;producer&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:624<span class="token punctuation">}</span>
Producer <span class="token number">1</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:5,<span class="token string">&quot;producer&quot;</span>:1,<span class="token string">&quot;timeout&quot;</span>:636<span class="token punctuation">}</span>
Producer <span class="token number">2</span> send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:5,<span class="token string">&quot;producer&quot;</span>:2,<span class="token string">&quot;timeout&quot;</span>:530<span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">0</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">4534</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">1</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">515</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">0</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">4903</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">2</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">1027</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">1</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">1077</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">3</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">430</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">2</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">800</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">4</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">537</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">3</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">1175</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">5</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">636</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">4</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">624</span> <span class="token punctuation">}</span>
Listener starts <span class="token punctuation">{</span> id: <span class="token number">5</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">530</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">3</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">430</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">1</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">515</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">5</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">530</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">4</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">537</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">4</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">624</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">5</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">636</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">2</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">800</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">2</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">1027</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">1</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">1077</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">3</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">1175</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">0</span>, producer: <span class="token number">1</span>, timeout: <span class="token number">4534</span> <span class="token punctuation">}</span>
Listener complete <span class="token punctuation">{</span> id: <span class="token number">0</span>, producer: <span class="token number">2</span>, timeout: <span class="token number">4903</span> <span class="token punctuation">}</span>

</code></pre></div><h2 id="послідовнии-робочии-процес-оброблення-повідомлень"><a href="#послідовнии-робочии-процес-оброблення-повідомлень" class="header-anchor">#</a> Послідовний робочий процес оброблення повідомлень</h2> <p>Організація послідовного робочого процесу оброблення повідомлень пов'язана з використанням в екземплярах мікросервісів
публікувальників та споживачів повідомлень. Мікросервіси-джерела, наприклад <code>initiator</code>, мають публікувальника;
проміжні обробники (<code>worker1</code>) - як публікувальника, так і споживача, стоки повідомлень (<code>worker2</code>)- тільки споживача.</p> <center><img src="https://www.plantuml.com/plantuml/svg/XLB1Ri8m3BttAomuS09fExCA2N7VxhkOu46rDWbkeY6X_ViIDoc5jLiEKUBuFJy_PzCwPEURkYWWh0_6Xg3IbQlG6OQhHEDIfh56atO0i_xzNLk_hwlsH3o3zVgLpS4huh84R2EBXJaY4QBGVCikszcJfy2aGxaNMFI4YqYpkwWJwYFrD9HfHi0FsBVube5qlbNiElio_4dyz7zVokZMDrrRstJkzIWOXTlK_i0L-6sBvKbNXXgV9pJUYanBj9mKJZkUQKOCj_odttV8WTsM1sxBx9VBKgQN8mGII5E9XvoYSeg2LRqgeqSIYLx5b20ftONZhbIuf9oEfTYGFeGF_GC0" alt="uml diagram"></center> <p>Для цього необхідно скористатись прикладами yaml конфігів, які наведені нижче. З головних деталей:</p> <ul><li><code>initiator-listener.yaml and initiator.yaml</code>: queue.exchange.name === exchange.name('initiator'), queue.exchange.mode === exchange.mode</li> <li><code>initiator-listener.yaml</code>: queue.options.noAck: true(manual підтвердження доставки)</li> <li><code>producer-listener.yaml and producer.yaml</code>: queue.exchange.name === exchange.name('producer'), queue.exchange.mode === exchange.mode</li> <li><code>producer-listener.yaml</code>: queue.options.noAck: true(manual підтвердження доставки)</li> <li>валідація повідомлень представлена(як і в минулих прикладах): message.id, message.producer, message.timeout</li></ul> <p>Initiator пара надсилає і отримує повідомлення, і під час останнього тригерить publisher з інших пари, який запускає вже свій процес з надсилання і отрмування повідомлення відповідно cunsumer. Queue та exchange для кожної пари різний.</p> <p><em><strong>Файл <code>initiator-listener.yaml</code></strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">queue</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> initiator
    
    <span class="token key atrule">exchange</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> initiator
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">noAck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        
      

</code></pre></div><p><em><strong>Файл <code>initiator.yaml</code></strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">exchange</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> initiator
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

</code></pre></div><p><em><strong>Файл <code>producer-listener.yaml</code></strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">queue</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> producer
    
    <span class="token key atrule">exchange</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> producer
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">noAck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

</code></pre></div><p><em><strong>Файл <code>producer.yaml</code></strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">exchange</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> producer
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

</code></pre></div><p><em><strong>Код прикладу</strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js<span class="token punctuation">,</span> getMetrics <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initiatorOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./initiator.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initiatorListenerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs
    <span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./initiator-listener.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> producerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./producer.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> producerListenerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs
    <span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./producer-listener.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> messageSchema <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./message.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> initiator <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>initiatorOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> initiator<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Initiator send '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> producer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>producerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Producer send '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> initiatorListener <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>
    initiatorListenerOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> initiatorListener
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>

      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Initiator listener starts'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Initiator listener complete'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
          msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> producerListener <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>
    producerListenerOptions<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> producerListener
    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
      Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>

      <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Producer listener consume'</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> initiator<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    meta<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    initiator<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> i<span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> initiator<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> initiatorListener<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> producerListener<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:0,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:4133<span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:678<span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:2,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:527<span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:3,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:591<span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:4,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:1094<span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:5,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:470<span class="token punctuation">}</span>
Initiator listener starts <span class="token punctuation">{</span> id: <span class="token number">0</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">4133</span> <span class="token punctuation">}</span>
Initiator listener starts <span class="token punctuation">{</span> id: <span class="token number">1</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">678</span> <span class="token punctuation">}</span>
Initiator listener starts <span class="token punctuation">{</span> id: <span class="token number">2</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">527</span> <span class="token punctuation">}</span>
Initiator listener starts <span class="token punctuation">{</span> id: <span class="token number">3</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">591</span> <span class="token punctuation">}</span>
Initiator listener starts <span class="token punctuation">{</span> id: <span class="token number">4</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">1094</span> <span class="token punctuation">}</span>
Initiator listener starts <span class="token punctuation">{</span> id: <span class="token number">5</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">470</span> <span class="token punctuation">}</span>
Initiator listener complete <span class="token punctuation">{</span> id: <span class="token number">5</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">470</span> <span class="token punctuation">}</span>
Producer send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:5,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2021-11-26T10:05:51.789Z&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:470<span class="token punctuation">}</span>
Initiator listener complete <span class="token punctuation">{</span> id: <span class="token number">2</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">527</span> <span class="token punctuation">}</span>
Producer send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:2,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2021-11-26T10:05:51.848Z&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:527<span class="token punctuation">}</span>
Initiator listener complete <span class="token punctuation">{</span> id: <span class="token number">3</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">591</span> <span class="token punctuation">}</span>
Producer send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:3,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2021-11-26T10:05:51.909Z&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:591<span class="token punctuation">}</span>
Producer listener consume <span class="token punctuation">{</span>
  id: <span class="token number">5</span>,
  meta: <span class="token punctuation">{</span> timestamp: <span class="token string">'2021-11-26T10:05:51.789Z'</span> <span class="token punctuation">}</span>,
  timeout: <span class="token number">470</span>
<span class="token punctuation">}</span>
Initiator listener complete <span class="token punctuation">{</span> id: <span class="token number">1</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">678</span> <span class="token punctuation">}</span>
Producer send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2021-11-26T10:05:51.997Z&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:678<span class="token punctuation">}</span>
Producer listener consume <span class="token punctuation">{</span>
  id: <span class="token number">2</span>,
  meta: <span class="token punctuation">{</span> timestamp: <span class="token string">'2021-11-26T10:05:51.848Z'</span> <span class="token punctuation">}</span>,
  timeout: <span class="token number">527</span>
<span class="token punctuation">}</span>
Producer listener consume <span class="token punctuation">{</span>
  id: <span class="token number">3</span>,
  meta: <span class="token punctuation">{</span> timestamp: <span class="token string">'2021-11-26T10:05:51.909Z'</span> <span class="token punctuation">}</span>,
  timeout: <span class="token number">591</span>
<span class="token punctuation">}</span>
Producer listener consume <span class="token punctuation">{</span>
  id: <span class="token number">1</span>,
  meta: <span class="token punctuation">{</span> timestamp: <span class="token string">'2021-11-26T10:05:51.997Z'</span> <span class="token punctuation">}</span>,
  timeout: <span class="token number">678</span>
<span class="token punctuation">}</span>
Initiator listener complete <span class="token punctuation">{</span> id: <span class="token number">4</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">1094</span> <span class="token punctuation">}</span>
Producer send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:4,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2021-11-26T10:05:52.412Z&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:1094<span class="token punctuation">}</span>
Producer listener consume <span class="token punctuation">{</span>
  id: <span class="token number">4</span>,
  meta: <span class="token punctuation">{</span> timestamp: <span class="token string">'2021-11-26T10:05:52.412Z'</span> <span class="token punctuation">}</span>,
  timeout: <span class="token number">1094</span>
<span class="token punctuation">}</span>
Initiator listener complete <span class="token punctuation">{</span> id: <span class="token number">0</span>, meta: <span class="token punctuation">{</span><span class="token punctuation">}</span>, timeout: <span class="token number">4133</span> <span class="token punctuation">}</span>

Producer send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:0,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2021-11-26T10:05:55.330Z&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;timeout&quot;</span>:4133<span class="token punctuation">}</span>
Producer listener consume <span class="token punctuation">{</span>
  id: <span class="token number">0</span>,
  meta: <span class="token punctuation">{</span> timestamp: <span class="token string">'2021-11-26T10:05:55.330Z'</span> <span class="token punctuation">}</span>,
  timeout: <span class="token number">4133</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="часткове-оброблення-повідомлень-та-композиция-результатів"><a href="#часткове-оброблення-повідомлень-та-композиция-результатів" class="header-anchor">#</a> Часткове оброблення повідомлень та композиция результатів</h2> <p>Використовуючи схему взаємодії для прослуховування декількома споживачами однієї черги повідомлень та
схему взаємодії для об'єднання потоків повідомлень, можна організувати паралельне часткове оброблення
повідомлень з наступною композицією їх результатів.</p> <center><img src="https://www.plantuml.com/plantuml/svg/dLHRQiCm4FpFAPRqEpb1C07JZq0ApGdAucnJWIsxbWI5qhjNibUsrh7emnY4FFkOqQnyD1Pxwvfw0-3VyBpss120qiegj6qFdmm0L6tJjPgq1TXE-1OEX-U-lRgA-g80D72QKXyGYH2vmDUmykRTaVDjjWqPWpSoeSpZH_M6-aPZcIT6OfLSvekcWSGbV9Uf0Sfb6SmbcKYObrdFhfYY69j8xX9ihh0EZwp4UNVU1eMrpyoSTwsC9LPQjjgu9XxtcP6vgypis9nxe-8kT9LMGLeLzlj2n4wFC3QZoDVulwJPlpzh2dspeW8eL8KFFyXAxHlyN66PJ80CMSvK7CT1bF41IdVEtb-2Kk3Bgy2BK17Qognb57DR3HBqLjWbzwKyNMJIWcjeiGmPHoEMJURYjvDHdjVDyPr6KG7V74bV_K_j6m00" alt="uml diagram"></center> <p><em><strong>Файл <code>initiator.yaml</code></strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">exchange</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> messages
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

</code></pre></div><p><em><strong>Файл <code>partial-listener.yaml</code></strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">queue</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> messages
    
    <span class="token key atrule">exchange</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> messages
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

    <span class="token key atrule">options</span><span class="token punctuation">:</span>
        <span class="token key atrule">noAck</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    
</code></pre></div><p><em><strong>Файл <code>partial-producer.yaml</code></strong></em></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>
<span class="token key atrule">amqp</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> amqps<span class="token punctuation">:</span>//xoilebqg<span class="token punctuation">:</span>Nx46t4t9cxQ2M0rF2rIyZPS_xbAhmJIG@hornet.rmq.cloudamqp.com/xoilebqg

<span class="token key atrule">exchange</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> composer_input
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> fanout

</code></pre></div><p><em><strong>Файл <code>partial.js</code></strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js<span class="token punctuation">,</span> getMetrics <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@molfar/amqp-client'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> partialListenerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs
    <span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./partial-listener.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> partialProducerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs
    <span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./partial-producer.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> messageSchema <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./message.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> producer <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>partialProducerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  partialListenerOptions<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>partialListenerOptions<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> listener <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>partialListenerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> listener<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> delay <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>partial<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          complete<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          timeout<span class="token operator">:</span> delay<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> listener<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">close</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> listener<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Файл <code>initiator.js</code></strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/* eslint-disable no-unused-vars */</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AmqpManager<span class="token punctuation">,</span> Middlewares<span class="token punctuation">,</span> yaml2js<span class="token punctuation">,</span> getMetrics <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../lib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initiatorOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./initiator.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> messageSchema <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./message.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> initiator <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createPublisher</span><span class="token punctuation">(</span>initiatorOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> initiator<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>stringify<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Initiator send '</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> initiator<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Файл <code>composer.js</code></strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/* eslint-disable no-unused-vars */</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  AmqpManager<span class="token punctuation">,</span>
  Middlewares<span class="token punctuation">,</span>
  yaml2js<span class="token punctuation">,</span>
  deepExtend<span class="token punctuation">,</span>
  getMetrics<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../lib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> composerListenerOptions <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs
    <span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./composer-listener.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> messageSchema <span class="token operator">=</span> <span class="token function">yaml2js</span><span class="token punctuation">(</span>
  fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./message.yaml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> messageBuffer <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> listener <span class="token operator">=</span> <span class="token keyword">await</span> AmqpManager<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span>composerListenerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> listener<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Middlewares<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>parse<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span><span class="token function">validator</span><span class="token punctuation">(</span>messageSchema<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Log<span class="token punctuation">,</span>
    Middlewares<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>BreakChain<span class="token punctuation">,</span>

    <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>meta <span class="token operator">=</span> <span class="token function">deepExtend</span><span class="token punctuation">(</span>
          messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">,</span>
          msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>meta<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>partial<span class="token punctuation">.</span>ner <span class="token operator">&amp;&amp;</span>
        messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>partial<span class="token punctuation">.</span>sa
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token string">'Composer complete partials'</span><span class="token punctuation">,</span>
          <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> messageBuffer<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> listener<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Файл <code>index.js</code></strong></em></p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">/* eslint-disable no-unused-vars */</span>

<span class="token keyword">const</span> <span class="token constant">INITIATOR</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./initiator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PARTIAL</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./partial'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">COMPOSER</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./composer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> initiator <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">INITIATOR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ner <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">PARTIAL</span><span class="token punctuation">(</span><span class="token string">'ner'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sa <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">PARTIAL</span><span class="token punctuation">(</span><span class="token string">'sa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> composer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token constant">COMPOSER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> ner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> sa<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> composer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> phrase <span class="token operator">=</span> <span class="token string">'This is very small workflow'</span><span class="token punctuation">;</span>

  phrase<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">word<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> initiator<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> index<span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
        text<span class="token operator">:</span> word<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span>
        partial<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> initiator<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> ner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> sa<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> composer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><em><strong>Результат</strong></em></p> <div class="language-sh extra-class"><pre class="language-sh"><code>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:0,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;This&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;partial&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:1,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;is&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;partial&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:2,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;very&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;partial&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:3,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;small&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;partial&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
Initiator send  <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:4,<span class="token string">&quot;data&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;workflow&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;meta&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;partial&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
Composer complete partials <span class="token punctuation">{</span>
 <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token number">4</span>,
 <span class="token string">&quot;data&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;workflow&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token string">&quot;meta&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;partial&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;ner&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">246</span>
   <span class="token punctuation">}</span>,
   <span class="token string">&quot;sa&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">418</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Composer complete partials <span class="token punctuation">{</span>
 <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
 <span class="token string">&quot;data&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;small&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token string">&quot;meta&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;partial&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;ner&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">585</span>
   <span class="token punctuation">}</span>,
   <span class="token string">&quot;sa&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">853</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Composer complete partials <span class="token punctuation">{</span>
 <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
 <span class="token string">&quot;data&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;This&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token string">&quot;meta&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;partial&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;sa&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">571</span>
   <span class="token punctuation">}</span>,
   <span class="token string">&quot;ner&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">995</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Composer complete partials <span class="token punctuation">{</span>
 <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
 <span class="token string">&quot;data&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;is&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token string">&quot;meta&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;partial&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;sa&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">721</span>
   <span class="token punctuation">}</span>,
   <span class="token string">&quot;ner&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1004</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Composer complete partials <span class="token punctuation">{</span>
 <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
 <span class="token string">&quot;data&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;text&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;very&quot;</span>
 <span class="token punctuation">}</span>,
 <span class="token string">&quot;meta&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;partial&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;ner&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">566</span>
   <span class="token punctuation">}</span>,
   <span class="token string">&quot;sa&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;complete&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;timeout&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1192</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Останнє оновлення:</span> <span class="time">12/1/2021, 12:07:05 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/amqp-client/requirements/" class="prev">
        Вимоги
      </a></span> <span class="next"><a href="/amqp-client/api/">
        Специфікація модуля
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/amqp-client/assets/js/app.867c8b74.js" defer></script><script src="/amqp-client/assets/js/2.3c9290c8.js" defer></script><script src="/amqp-client/assets/js/18.2e71cec6.js" defer></script>
  </body>
</html>
